<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="utf-8">
      <title>Slider</title>
      <script type="text/javascript" src= "https://d3js.org/d3.v6.js"></script>
      <script type="text/javascript" src= "../d3-simple-slider.js"></script>
      <link rel="stylesheet" href="styles.css">
  </head>
  <body>

    <section>
      <h1>American Democracy Is Rigged Against Democrats</h1>
      <div class="intro">
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
        <div id="slider"></div>
        <div id="summaryResult"></div>
      </div>
    </section>

    <section>
      <h2>The Presidency</h2>
      <div class="explainer">
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
      </div>
      <div class="panel">
        <div id="presSlider"></div>
        <div id="presResult"></div>
        <svg id="presMap" class="vis"></svg>
        <svg id="presChart" class="vis"></svg>
      </div>
    </section>

    <section>
      <h2>The House of Representatives</h2>
      <div class="explainer">
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
      </div>
      <div class="panel">
        <div id="houseSlider"></div>
        <div id="houseResult"></div>
        <svg id="houseMap" class="vis"></svg>
        <svg id="houseChart" class="vis"></svg>
      </div>
    </section>
    
    <section>
      <h2>The Senate</h2>
      <div class="explainer">
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
      </div>
      <div class="panel">
        <div id="senateSlider"></div>
        <div id="senateResult"></div>
        <svg id="senateMap" class="vis"></svg>
        <svg id="senateChart" class="vis"></svg>
      </div>
    </section>
        
    <script type="text/javascript">
    
    Promise.all([
	    d3.csv("data/pres_data.csv"),
	    d3.csv("data/house_data.csv"),
	    d3.csv("data/senate_data.csv")
	])
     .then(function(data) {

      const pres_data = data[0];
      const house_data = data[1];
      const senate_data = data[2];

      console.log(pres_data);
      console.log(house_data);
      console.log(senate_data);


      // DIMENSIONS

      // margins

      const margin = {
        top: 10,
        right: 10,
        bottom: 10,
        left: 10
      };

      // squares

      const squareScale = 1.5

      const pres_square = {
        w: squareScale * 30,
        h: squareScale * 30
      };
      const house_square = {
        w: squareScale * 4,
        h: squareScale * 4
      };
      const senate_square = {
        w: squareScale * 7,
        h: squareScale * 7
      };

      // panel dimensions

      const panelWidth = 600;

      const map = {
        w: panelWidth, // width of map
        h: panelWidth * 0.61835245046 // map aspect ratio
      };

      const bar = {
        w: panelWidth, // width of map
        h: panelWidth / 87 * 5 // sets height all bar charts so that house squares will be perfectly square (house grid is 87 by 5)
      };

      const introSlider = {
        w: panelWidth,
        h: 150
      }


      // SCALES

      const red = '#cf4938';
      const blue = '#4287f5';

      // color scale
      const leanColor = d3.scaleThreshold()
        .domain([0]) // split at 0
        .range([blue, red]);

      // pres state size scale
      const presSize = d3.scaleSqrt()
      	.domain([0, 55]) // max electoral votes is 55 (California)
      	.range([0, pres_square.w]);
      
      // slider min/max
      const voteMaxD = -8;
      const voteMaxR = 8;
      // slider increment
      const increment = 2;
      // create array of integers to use for slider ticks
      const voteRange = [];
      for (var i = voteMaxD; i <= voteMaxR; i = i + increment) {
        voteRange.push(i);
      }


      // SLIDER

     // define the slider
     const slider = d3.sliderTop()
        .min(voteMaxD)
        .max(voteMaxR)
        .default(0)
        .step(.5)
        .width(introSlider.w - 30)
        // custom slider symbol
        .handle(
          d3.symbol()
            .type(d3.symbolCircle)
            .size(150)()
          )
        .tickValues(voteRange)
        // remove minus signs
        .tickFormat(Math.abs)
        .displayValue(false)
        // onchange, pass slider value to update function
        .on('onchange', function (value) {
          update(value);
        });

      // add the slider
      d3.select('#slider')
        .append('svg')
        .attr('width', introSlider.w)
        .attr('height', introSlider.h)
        .append('g')
        .attr('transform', 'translate(15,75)')
        .call(slider);


      // SVG dimensions
      const svg1 = d3.select('#presMap')
        .attr('width', map.w + margin.left + margin.right)
        .attr('height', map.h + margin.top + margin.bottom);

      const svg2 = d3.select('#houseMap')
        .attr('width', map.w + margin.left + margin.right)
        .attr('height', map.h + margin.top + margin.bottom);

      const svg3 = d3.select('#senateMap')
        .attr('width', map.w + margin.left + margin.right)
        .attr('height', map.h + margin.top + margin.bottom);

      const svg4 = d3.select('#presChart')
        .attr('width', bar.w + margin.left + margin.right)
        .attr('height', bar.h + margin.top + margin.bottom);

      const svg5 = d3.select('#houseChart')
        .attr('width', bar.w + margin.left + margin.right)
        .attr('height', bar.h + margin.top + margin.bottom);

      const svg6 = d3.select('#senateChart')
        .attr('width', bar.w + margin.left + margin.right)
        .attr('height', bar.h + margin.top + margin.bottom);

      // add g for each state in appropriate position
      // const g = svg.append('g')
      //   .selectAll('g')
      //   .data(data)
      //   .enter()
      //   .append('g')
      //   .attr('transform', d=>{return 'translate(' + (d.col * square.w + margin.left) + ',' + (d.row * square.h + margin.top) + ')';});

      // MAPS

      // basemaps
      const basemap = function (svg) {
	      svg.append("svg:image")
		    .attr("xlink:href", "media/us_map.svg")
		    .attr("width", map.w)
		    .attr("x", margin.left)
		    .attr("y",margin.top);
		};

	  basemap(svg1);
	  basemap(svg2);
	  basemap(svg3);

	  // const districtsByState = d3.rollup(house_data, v => d3.max(v, d => +d.state_x), d=> d.state_abbr);

	  // console.log(districtsByState);

      presSquares = svg1.selectAll('rect')
        .data(pres_data)
        .join('rect')
        // x and y position account for size of square in order to center square
        .attr('x', d=> (+d.state_x + +d.offset_x) * map.w + margin.left - presSize(+d.electors) / 2)
        .attr('y', d=> (+d.state_y + +d.offset_y) * map.h + margin.top - presSize(+d.electors) / 2)
        .attr('width', d=> presSize(+d.electors))
        .attr('height', d=> presSize(+d.electors))
        .attr('class', 'rect');

      houseSquares = svg2.selectAll('rect')
        .data(house_data)
        .join('rect')
        // position squares for each state, using state coordinates and then using modulo to create columns, with column size determined by the square root of the total districts in state, resulting in roughly square grids
        .attr('x', (d, i)=> {return (+d.state_x + +d.offset_x) * map.w + margin.left + Math.floor((d.district_number - 1) / Math.ceil(Math.sqrt(d.state_total))) * house_square.w - Math.ceil(Math.sqrt(d.state_total)) * house_square.w / 2;})
        .attr('y', (d, i)=> {return (+d.state_y + +d.offset_y) * map.h + margin.top + ((d.district_number - 1) % Math.ceil(Math.sqrt(d.state_total))) * house_square.h - Math.ceil(Math.sqrt(d.state_total)) * house_square.h / 2;})
        .attr('width', house_square.w)
        .attr('height', house_square.h)
		.attr('class', 'rect');	

      senateSquares = svg3.selectAll('rect')
        .data(senate_data)
        .join('rect')
        .attr('x', d=> +d.state_x * map.w + +d.offset_x * senate_square.w + margin.left)
        .attr('y', d=> +d.state_y * map.h + +d.offset_y * senate_square.h + margin.top)
        .attr('width', senate_square.w)
        .attr('height', senate_square.h)
        .attr('class', 'rect');


      // BAR CHARTS

      // function for stacking data (for pres bar chart)
      const myStack = function (dataToStack) {
		  const total = d3.sum(dataToStack, d => d.electors);
		  let stackPosition = 0;
		  return dataToStack.sort((a,b)=>d3.ascending(+a.rlean, +b.rlean))
		  	.map(d => ({
			    state: d.state,
			    col: d.col,
			    row: d.row,
			    rlean: d.rlean,
			    electors: +d.electors,
			    startPosition: stackPosition,
			    endPosition: (stackPosition += +d.electors)
		  	}));
	  };

      presBar = svg4.selectAll('rect')
        .data(myStack(pres_data)) // uses stacked data
        .join('rect')
        .attr('x', d=> d.startPosition / 538 * bar.w + margin.left)
        .attr('y', margin.top)
        .attr('width', d=> d.electors / 538 * bar.w)
        .attr('height', bar.h)
        //.attr('vector-effect', 'non-scaling-stroke')
        .attr('class', 'rect');

      houseBar = svg5.selectAll('rect')
        .data(house_data.sort((a,b)=>d3.ascending(+a.rlean, +b.rlean)))
        .join('rect')
        // determine x and y, wrapping from one column to the next (wrap to next column after 5 squares)
        .attr('x', (d, i)=>{return Math.floor(i / 5) * bar.w / 87 + margin.left;}) // use math.floor to determine column
        .attr('y', (d, i)=>{return (i % 5) * bar.h / 5 + margin.top;}) // use modulo to determine row
        .attr('width', bar.w / 87)
        .attr('height', bar.h / 5)
        .attr('class', 'rect');

      senateBar = svg6.selectAll('rect')
        .data(senate_data.sort((a,b)=>d3.ascending(+a.rlean, +b.rlean)))
        .join('rect')
        .attr('x', (d, i)=> i * bar.w / 100 + margin.left)
        .attr('y', margin.top)
        .attr('width', bar.w / 100)
        .attr('height', bar.h)
        .attr('class', 'rect');

      
      // COLOR

      // function for updating colors
      function update(vote) {

      	const graphics = [presSquares, houseSquares, senateSquares, presBar, houseBar, senateBar];

		// can add transition before .style
		graphics.forEach(item => item.style('fill', d => {
			return leanColor(+d.rlean + vote);
		}));

	  };

	  // initial color (popular vote = 0)
      update(0);

        



      // TEST labels
      // g.append('text')
      //   .attr('x', square.w / 2)
      //   .attr('y', square.h / 2)
      //   .style('text-anchor', 'middle')
      //   .attr('transform', 'translate(0,5)')
      //   .style('fill', '#ffffff')
      //   .attr('class', 'label')
      //   .text(d=> {return d.rlean;});


      // NOTES

      // could also try using if instead of leanColor in case it gives better performance:
      // if (d.rlean >= 0) {
      //   return '#cf4938';
      // } else {
      //   return '#4287f5';
      // }

    })
        .catch(function(error){
          // handle error 
          console.log(error);
    });

    </script>
  </body>
</html>